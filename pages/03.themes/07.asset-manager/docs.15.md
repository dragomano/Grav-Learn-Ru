---
title: Менеджер активов
page-toc:
  active: true
taxonomy:
    category: docs
---

Новая функция, представленная в Grav 0.9.0, для унификации интерфейса по всей Grav для добавления и управления **CSS** и **JavaScript**. Основная цель диспетчера активов является упрощение процесса добавления активов из тем и плагинов, обеспечивая расширенные возможности, такие как заказ, а также предоставление **Asset Pipeline**, который может быть использован для **minify**, **compress** и **inline** активов, чтобы уменьшить количество запросов браузера, а также общий размер активов.

Диспетчер активов - это просто класс, который доступен в Grav через крючки событий плагинов, а также непосредственно в темах с помощью Twig-звонков.

## Конфигурация

Grav Asset Manager имеет простой набор опций настройки. Значения по умолчанию находятся в системном `system.yaml` файле, но вы можете переопределить любые или все из них в вашем `user/config/system.yaml` файле:

[prism classes="language-yaml line-numbers"]
assets:                                # Конфигурация для диспетчера активов (JS, CSS)
  css_pipeline: false                  # Если это так, включите конвейер CSS, объединив несколько ресурсов CSS в один.
  css_pipeline_include_externals: true # Включить внешние ресурсы КОС из трубопровода
  css_pipeline_before_excludes: true   # Отправители трубопроводных ресурсов CSS до неопроводных ресурсов CSS
  css_minify: true                     # Минимизация CSS во время прокладки трубопроводов
  css_minify_windows: true             # Если false, блокирует минирование на серверах Windows
  css_rewrite: true                    # Перепишите все относительные URL-адреса CSS во время конвейеризации
  js_pipeline: false                   # Если true, то включает конвейер JS, объединяя несколько ресурсов JS в один
  js_pipeline_include_externals: true  # Включить внешние ресурсы JS из конвейера
  js_pipeline_before_excludes: true    # Оказывает конвейерные JS ресурсы, прежде чем непоследовательные ресурсы JS
  js_minify: true                      # Уменьшите JS во время конвейеризации
  enable_asset_timestamp: false        # Если true, то добавляет параметр URL-запроса к каждой ссылке актива для недействительности кэша
[/prism]

## Активы в темах

### Обзор

В общем, вы добавляете CSS активы по одному, используя вызовы `assets.add*()`, а затем визуализируете эти активы с помощью `assets.css()`. Опции, контролирующие заказ, обвязку или встраивание, могут быть указаны для каждого актива при его добавлении или при отрисовке для группы активов.

Активы JS также управляются.

Менеджер активов также поддерживает
* добавление активов к именованным группам с целью отображения таких групп в разных местах и/или с разными наборами опций,
* настройка именованных коллекций активов, которые могут быть добавлены в один вызов `assets.add*()`.

### Пример

Пример того, как вы можете добавить CSS-файлы в вашей теме можно найти в теме по умолчанию **antimatter**, которая поставляется в комплекте с Grav. Если вы посмотрите на `base.html.twig` частично и конкретно на [блок таблиц стилей](https://github.com/getgrav/grav-theme-antimatter/blob/develop/templates/partials/base.html.twig#L12-L28), то увидите следующее:

[prism classes="language-twig line-numbers"]
{% block stylesheets %}
    {% do assets.addCss('theme://css/pure-0.5.0/grids-min.css', 103) %}
    {% do assets.addCss('theme://css-compiled/nucleus.css',102) %}
    {% do assets.addCss('theme://css-compiled/template.css',101) %}
    {% do assets.addCss('theme://css/custom.css',100) %}
    {% do assets.addCss('theme://css/font-awesome.min.css',100) %}
    {% do assets.addCss('theme://css/slidebars.min.css') %}

    {% if browser.getBrowser == 'msie' and browser.getVersion == 10 %}
        {% do assets.addCss('theme://css/nucleus-ie10.css') %}
    {% endif %}
    {% if browser.getBrowser == 'msie' and browser.getVersion >= 8 and browser.getVersion <= 9 %}
        {% do assets.addCss('theme://css/nucleus-ie9.css') %}
        {% do assets.addJs('theme://js/html5shiv-printshiv.min.js') %}
    {% endif %}
{% endblock %}
{{ assets.css() }}
[/prism]

Тег `block` twig просто определяет область, которая может быть заменена или дополнена в шаблонах, которые расширяют эту область. Внутри блока вы увидите ряд вызовов `do assets.addCss()`.

Тег `{% do %}` на самом деле является [встроенным в Twig](http://twig.sensiolabs.org/doc/tags/do.html), и позволяет манипулировать переменными без генерации какого-либо вывода.

Метод `addCss()` добавляет ресурсы CSS в менеджер активов. Если вы указываете второй числовой параметр, он устанавливает приоритет таблицы стилей. В этом случае мы хотим, чтобы `grids-min.css` был первым, так как он имеет наивысшее значение приоритета. Вы заметите использование **оболочки потока PHP** `theme://`, чтобы предоставить Grav простой способ определения относительного пути текущей темы.

Вызов `assets.css()` выводит CSS-активы в виде HTML-тегов.

Активы JavaScript очень похожи:

[prism classes="language-js line-numbers"]
{% block javascripts %}
    {% do assets.addJs('jquery',101) %}
    {% do assets.addJs('theme://js/modernizr.custom.71422.js',100) %}
    {% do assets.addJs('theme://js/antimatter.js') %}
    {% do assets.addJs('theme://js/slidebars.min.js') %}
    {% do assets.addInlineJs('alert(\'This is inline!\')') %}
{% endblock %}
{{ assets.js() }}
[/prism]

## Добавление активов

#### add(asset, [options])

Метод добавления делает все возможное, чтобы сопоставить актив на основе расширения файла. Это удобный метод, лучше вызвать один из прямых методов для CSS или JS. Подробнее см. Прямые методы.

!! Массив параметров - предпочтительный подход для передачи нескольких параметров. Однако, как и в предыдущих примерах, вы можете использовать ярлык и передать целое число для **второго аргумента** в методе, если всё, что вы хотите установить, это **приоритет**.

#### addCss(asset, [options])

Этот метод добавит активы в список ресурсов CSS. По умолчанию приоритет 10, если он не указан. Более высокое число означает, что оно будет отображаться перед активами с более низким приоритетом. Опция `pipeline` контролирует, должен ли этот актив быть включен в конвейер объединения/минимизации. Если не конвейерный, опция `loading` контролирует, должен ли актив отображаться как ссылка на внешнюю таблицу стилей или его содержимое должно быть встроено во встроенный тег стиля.

#### addDirCss(directory)

Добавьте весь каталог ресурсов CSS за один раз. Порядок будет в алфавитном порядке. Этот метод не обеспечивает управление отдельными методами и, как правило, не является предпочтительным.

#### addInlineCss(css, [options])

Позволяет добавить строку CSS внутри тега стиля inline. Полезно для инициализации или чего-либо динамического.  Чтобы вставить содержимое обычного файла актива, см. пункт `{'loading': 'inline'}` опция методов `addCss()` и `css()`.

#### addJs(asset, [options])

Этот метод добавит ресурсы в список ресурсов JavaScript. По умолчанию приоритет 10, если он не указан. Более высокое число означает, что оно будет отображаться перед активами с более низким приоритетом. Опция `pipeline` контролирует, должен ли этот актив быть включен в конвейер объединения минимизации. Если не конвейерно, опция `loading` определяет, должен ли ресурс отображаться как ссылка на внешний файл сценария или его содержимое должно быть встроено во встроенный тег сценария.

#### addInlineJs(javascript, [options])

Позволяет добавить строку JavaScript во встроенный тег скрипта. Полезно для инициализации или чего-нибудь динамического. Чтобы встроить содержимое обычного файла актива, см. пункт `{'loading': 'inline'}` опция методов `addJs()` и `js()`.

#### addDirJs(directory)

Добавьте весь каталог ресурсов JavaScript за один раз. Порядок будет в алфавитном порядке. Этот метод не обеспечивает управление отдельными методами и, как правило, не является предпочтительным.

#### registerCollection(name, array)

Позволяет зарегистрировать массив CSS и JavaScript активов с именем для последующего использования методом `add()`. Особенно полезно, если вы хотите зарегистрировать коллекцию, которая может использоваться несколькими темами или плагинами, такими как jQuery или Bootstrap.

## Параметры

Там, где это уместно, можно передать массив опций активов. Этими вариантами являются

#### Для CSS

* **priority**: Целочисленное значение (по умолчанию `10`)

* **pipeline**: `false` если этот актив **не** должен быть включен в конвейер (по умолчанию `true`)

* **loading**: `inline` если этот актив должен быть вложен (по умолчанию: ссылка через ссылку на таблицу стилей)

    эффективно, только если для параметра `pipeline` установлено значение `false`, поскольку встраивание конвейера контролируется с помощью опции `loading` метода рендеринга `css()`

* **media**: медиа-запрос, такой как `only screen and (min-width: 640px)`

#### Для JS

* **priority**: Целочисленное значение (значение по умолчанию - `10`)

* **pipeline**: `false` если этот актив **не** должен быть включен в конвейер (по умолчанию `true`)

* **loading**: поддерживает пустое значение, `async`, `defer`, `async defer` или `inline`

    эффективно, только если для параметра `pipeline` установлено значение `false`, поскольку встраивание конвейера контролируется с помощью опции `loading` метода рендеринга `js()`

* **group**: строка для указания уникального имени группы для актива (по умолчанию `head`)

например:

[prism classes="language-twig"]
{% do assets.addJs('theme://js/example.js', {'priority':102, 'pipeline':false, 'loading':'async', 'group':'bottom'}) %}
[/prism]

## Рендеринг активов

Следующее позволяет отображать текущее состояние ресурсов CSS и JavaScript.

#### css([group, [options]])

Визуализирует CSS-активы, добавленные в группу менеджера активов (по умолчанию `head`). Варианты таковы

* **loading**: `inline` если **все** активы в этой группе должны быть встроены (по умолчанию: отображать каждый актив в соответствии с его опцией `loading` и не встраивать конвейер, если он есть)

* **_link attributes_**, см. ниже (по умолчанию: `{'type': 'text/css', 'rel': 'stylesheet'}`)

    эффективен, только если `inline` **не** используется в качестве параметра рендеринга этой группы

Если конвейеризация **отключена** в конфигурации, активы группы визуализируются индивидуально, упорядоченные по приоритету активов (от высокого к низкому), а затем в порядке добавления активов.

Если конвейеризация **включена** в конфигурации, активы, не исключенные из конвейеризации, объединяются в том порядке, в котором они были добавлены, а затем обрабатываются в соответствии с конфигурацией конвейера. Комбинированный результат конвейера затем визуализируется до или после непроверенных активов в зависимости от параметра `css_pipeline_before_excludes`.

Каждый актив отображается либо как ссылка таблицы стилей, либо как встроенный, в зависимости от параметра `loading` актива и от того, используется ли для рендеринга этой группы параметр `{'loading': `inline'}`. Обратите внимание, что единственный способ встроить конвейер CSS — это использовать встроенную загрузку в качестве опции метода `css()`.

CSS, добавленный addInlineCss(), всегда отображается последним.

#### js([group, [options]])

Визуализирует активы JavaScript, добавленные в группу менеджера активов (по умолчанию `head`). Варианты таковы

* **loading**: `inline` если **все** активы в этой группе должны быть встроены (по умолчанию: отображать каждый актив в соответствии с его опцией `loading` и не встраивать конвейер, если он есть)

* **_script attributes_**, см. ниже (по умолчанию: `{'type': 'text/javascript'}`)

    эффективен, только если `inline` **не** используется в качестве параметра рендеринга этой группы

Если конвейеризация **отключена** в конфигурации, активы группы визуализируются индивидуально, упорядоченные по приоритету активов (от высокого к низкому), а затем в порядке добавления активов.

Если конвейеризация **включена** в конфигурации, активы, не исключенные из конвейеризации, объединяются в том порядке, в котором они были добавлены, а затем обрабатываются в соответствии с конфигурацией конвейера. Комбинированный результат конвейера затем визуализируется до или после непроверенных активов в зависимости от параметра `js_pipeline_before_excludes`.

Каждый актив визуализируется либо как ссылка на скрипт, либо как встроенный, в зависимости от опции загрузки актива и того, используется ли для визуализации этой группы параметр `{'loading': `inline'}`. Обратите внимание, что единственный способ встроить конвейер JS — это использовать встроенную загрузку в качестве опции метода `js()`.

JavaScript, добавленный addInlineJs(), всегда отображается последним.

## Именованные активы

Теперь у Grav есть мощная функция **named assets**, которая позволяет вам регистрировать коллекцию CSS и JavaScript ресурсов по имени. Затем вы можете просто **добавить** эти активы в менеджер активов через имя, под которым вы зарегистрировали коллекцию. Grav поставляется с предварительно настроенным **jQuery**, но имеет возможность определять собственные коллекции в файле `system.yaml`, которые будут использоваться любой темой или плагином:

[prism classes="language-yaml line-numbers"]
assets:
  collections:
    jquery: system://assets/jquery/jquery-2.1.3.min.js
    bootstrap:
        - https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css
        - https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css
        - https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js
[/prism]

Вы также можете использовать метод `registerCollection()` программным способом.

[prism classes="language-yaml line-numbers"]
$assets = $this->grav['assets'];
$bootstrapper_bits = ['https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css',
                      'https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css',
                      'https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js'];
$assets->registerCollection('bootstrap', $bootstrap_bits);
$assets->add('bootstrap', 100);
[/prism]

Пример этого действия можно найти в плагине [**bootstrapper**](https://github.com/getgrav/grav-plugin-bootstrapper/blob/develop/bootstrapper.php#L51-L71).

## Сгруппированные активы

Новая функция была добавлена в Grav **0.9.43** это позволяет передавать необязательную `group` как часть массива опций при добавлении активов.  Это полезно для CSS, но особенно для JavaScript, где вам может понадобиться иметь некоторые JS-файлы или встроенные JS, на которые ссылаются в заголовке, а некоторые-в нижней части страницы.  До этого выпуска Grav это было невозможно с помощью менеджера активов, но теперь это так.

Чтобы воспользоваться этой возможностью, необходимо указать группу при добавлении актива и использовать синтаксис параметров:

[prism classes="language-twig line-numbers"]
{% do assets.addJs('theme://js/example.js', {'priority':102, 'group':'bottom'}) %}
[/prism]

Затем, чтобы эти активы в нижней группе отображались, вы должны добавить в свою тему следующее:

[prism classes="language-twig"]
{{ assets.js('bottom') }}
[/prism]

Если для актива не определена группа, то по умолчанию используется группа `head`. Если ни одна группа не настроена для рендеринга, то будет отрисована группа `head`. Это гарантирует, что новая функциональность на 100% обратно совместима с существующими темами.

То же самое относится и к CSS файлам:

[prism classes="language-twig"]
{% do assets.addCss('theme://css/ie8.css', {'group':'ie'}) %}
[/prism]

и рендеринг:


[prism classes="language-twig"]
{{ assets.css('ie') }}
[/prism]

## Изменение атрибутов визуализируемых активов CSS/JS

CSS по умолчанию добавлен с использованием атрибута `rel="stylesheet"` и `type="text/css"`, в то время как JS имеет `type="text/javascript"`.

Чтобы изменить настройки по умолчанию или добавить новые атрибуты, необходимо создать новую группу активов и сказать Grav, чтобы она отобразила его с этим атрибутом.

Пример редактирования атрибута `rel` на группе активов:

[prism classes="language-twig"]
{% do assets.addCSS('theme://whatever.css', {'group':'my-alternate-group'}) %}
...
{{ assets.css('my-alternate-group', {'rel': 'alternate'}) }}
[/prism]

## Встраивание активов

Возможность встроить ресурсы CSS и JS была добавлена ​​в Grav **1.2.1**. Размещение критически важного кода CSS (и JS) непосредственно в документе HTML позволяет браузеру немедленно отображать страницу, не дожидаясь загрузки внешней таблицы стилей или сценария. Это может заметно улучшить производительность сайта для пользователей, особенно в мобильных сетях. Подробности можно найти в [этой статье об оптимизации доставки CSS](https://developers.google.com/speed/docs/insights/OptimizeCSSDelivery).

Однако прямая вставка кода CSS или JavaScript в шаблон страницы не всегда возможна, например, когда используется Sass-совместимый CSS. Хранение ресурсов CSS и JS в отдельных файлах также упрощает обслуживание. Использование встроенных возможностей Asset Manager позволяет оптимизировать скорость без изменения способа хранения ваших активов. Могут быть встроены даже целые конвейеры.

Чтобы встроить содержимое файла ресурса, используйте опцию `{'loading': 'inline'}` с `addCss()` или `addJs()`. Вы также можете встроить все ресурсы при рендеринге группы с помощью `js()` или `css()`, которые предоставляют тот же параметр.

Пример использования `system.yaml` для определения коллекций ресурсов, названных в соответствии с требованиями к загрузке ресурсов, при этом `app.css` является файлом CSS, сгенерированным [Sass](https://sass-lang.com/):

[prism classes="language-yaml line-numbers"]
assets:
  collections:
    css-inline:
      - 'http://fonts.googleapis.com/css?family=Ubuntu:400|Open+Sans:400,400i,700'
      - 'theme://css-compiled/app.css'
    js-inline:
      - 'https://use.fontawesome.com/<embedcode>.js'
    js-async:
      - 'theme://foundation/dist/assets/js/app.js'
      - 'theme://js/header-display.js'
[/prism]

Шаблон вставляет каждую коллекцию в соответствующую группу, а именно `head` и `head-link` для CSS, `head` и `head-async` для JS. Группа по умолчанию `head` используется для последовательной загрузки в каждом случае:

[prism classes="language-twig line-numbers"]
        {% block stylesheets %}
            {% do assets.addCss('css-inline') %}
            {% do assets.addCss('css-link', {'group': 'head-link'}) %}
        {% endblock %}
        {{ assets.css('head-link') }}
        {{ assets.css('head', {'loading': 'inline'}) }}
        {% block javascripts %}
            {% do assets.addJs('js-inline') %}
            {% do assets.addJs('js-async', {'group': 'head-async'}) %}
        {% endblock %}
        {{ assets.js('head-async', {'loading': 'async'}) }}
        {{ assets.js('head', {'loading': 'inline'}) }}
[/prism]

## Статические активы

Иногда возникает необходимость ссылки на активы без использования Менеджера активов. Для этого имеется вспомогательный метод `url()`. Примером может служить, если вы хотите сослаться на изображение из темы. Синтаксис для этого:

[prism classes="language-twig"]
<img src="{{ url("theme://" ~ widget.image) }}" alt="{{ widget.text|e }}" />
[/prism]

Метод `url()` принимает необязательный второй параметр `true` или `false`, чтобы включить URL для включения схемы и домена. По умолчанию предполагается, что это значение `false`, в результате чего получается только относительный URL. Например:

[prism classes="language-twig"]
url("theme://some/extra.css", true)
[/prism]
